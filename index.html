<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±äº¬è¡Œ 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        starlux: { dark: '#3E3A35', brown: '#6B5B4E', gold: '#C5A572', cream: '#F8F4E3' },
                        sushi: { black: '#1a1a1a', wood: '#e6cda3' },
                        fuji: { blue: '#2c5ea8', white: '#f3f4f6' },
                        toyota: { red: '#eb0a1e' },
                        jr: { red: '#e60012' }, 
                        luger: { red: '#4a0e0e', gold: '#d4af37' },
                        threads: { black: '#101010' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 80px; background-color: #f8fafc; }
        
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .flight-card { background: linear-gradient(135deg, #3E3A35 0%, #5d5045 100%); color: #F8F4E3; box-shadow: 0 15px 30px -10px rgba(62, 58, 53, 0.6); border: 1px solid rgba(197, 165, 114, 0.1); }
        .sushi-card { background: #151515; color: #e6cda3; border: 1px solid #333; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        .snoopy-card { background: #fffbf0; border: 2px dashed #8b5e3c; color: #5d4037; }
        .bus-card { background: linear-gradient(135deg, #2c5ea8 0%, #1e4079 100%); color: white; box-shadow: 0 10px 20px -5px rgba(44, 94, 168, 0.4); border-left: 5px solid #fbbf24; }
        .rent-card { border-left: 5px solid #eb0a1e; }
        .fuji-forecast-card { background: linear-gradient(to bottom, #3b82f6 0%, #93c5fd 100%); color: white; position: relative; overflow: hidden; }
        .train-card { background: white; border-left: 6px solid #e60012; border-right: 1px solid #ddd; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .luger-card { background: #4a0e0e; color: #f3e5ab; border: 1px solid #d4af37; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.6); }
        .lounge-card { background: linear-gradient(135deg, #fdfbf7 0%, #fff 100%); border: 1px solid #e5e7eb; border-left: 4px solid #d4af37; }
        .threads-card { background: #101010; color: white; border: 1px solid #333; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .page-content, .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page-content.active, .tab-content.active { display: block; }
        
        .weather-widget { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .fuji-bg { position: absolute; bottom: -10px; right: -20px; font-size: 120px; opacity: 0.2; color: white; transform: rotate(-10deg); }

        .check-item { transition: all 0.2s; }
        .check-item.checked span { text-decoration: line-through; color: #9ca3af; }
        .check-item.checked { background-color: #f9fafb; }
        
        .date-btn { transition: all 0.2s; }
        .date-btn.active { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .weather-toggle-btn.active-sun { background-color: #fef3c7; color: #d97706; border-color: #d97706; }
        .weather-toggle-btn.active-rain { background-color: #e0f2fe; color: #0284c7; border-color: #0284c7; }
        .weather-plan { display: none; animation: fadeIn 0.4s ease; }
        .weather-plan.active { display: block; }

        /* Budget Payment Buttons Fixed */
        .pay-btn { border: 1px solid #e5e7eb; color: #6b7280; transition: all 0.2s; flex: 1; min-width: 60px; text-align: center; justify-content: center; }
        .pay-btn.active { background-color: #16a34a; color: white; border-color: #16a34a; font-weight: bold; }
        
        /* Input Fixes */
        input[type="number"], input[type="text"] { width: 100%; box-sizing: border-box; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-24">

    <div class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-gray-200 shadow-sm">
        <div class="max-w-md mx-auto px-4 pt-3 pb-2">
            <h1 class="text-lg font-bold text-center text-slate-800 mb-2">æ±äº¬ä¹‹æ—… 2025 ğŸ‡¯ğŸ‡µ</h1>
            <div class="flex space-x-2 overflow-x-auto hide-scrollbar pb-1" id="date-nav">
                </div>
        </div>
    </div>

    <div id="main-container" class="max-w-md mx-auto px-4 py-4 min-h-[80vh]"></div>
    // ==========================================
        // 2. æ ¸å¿ƒæ¸²æŸ“å¼•æ“
        // ==========================================
        function renderApp(viewId) {
            const container = document.getElementById('main-container');
            container.innerHTML = '';

            if (viewId === 'list') { renderPackingList(container); return; }
            if (viewId === 'budget') { renderBudget(container); return; }

            const dayData = tripData[viewId];
            if (!dayData) return;

            // æ¸²æŸ“å¤©æ°£
            if(dayData.weather) renderWeather(container, dayData.weather);

            // æ¸²æŸ“å…±ç”¨è¡Œç¨‹
            if (dayData.items) dayData.items.forEach(item => container.appendChild(createCard(item)));

            // æ¸²æŸ“åˆ†é è¡Œç¨‹ (å¦‚ Day 2, Day 5)
            if (dayData.tabs) {
                const tabContainer = document.createElement('div');
                tabContainer.className = "bg-gray-200 p-1 rounded-xl flex text-sm font-medium mt-4 mb-4";
                tabContainer.innerHTML = `
                    <button onclick="switchTab('${viewId}', 'brother')" id="tab-${viewId}-brother" class="tab-btn active flex-1 py-2 rounded-lg transition-all">å“¥å“¥</button>
                    <button onclick="switchTab('${viewId}', 'mom')" id="tab-${viewId}-mom" class="tab-btn flex-1 py-2 rounded-lg text-gray-500 transition-all">åª½åª½</button>
                `;
                container.appendChild(tabContainer);

                const contentDiv = document.createElement('div');
                contentDiv.id = `tab-content-${viewId}`;
                container.appendChild(contentDiv);
                
                // é è¨­é¡¯ç¤ºå“¥å“¥
                renderTabContent(viewId, 'brother', contentDiv);
            }

            // Day 2 ç‰¹æ®Š: æ··åˆäº† tabs å’Œ jointItems
            if(dayData.jointItems) {
                 dayData.jointItems.forEach(item => container.appendChild(createCard(item)));
            }
        }

        function createCard(item) {
            const div = document.createElement('div');
            
            // æ ¹æ“šé¡å‹ç”¢ç”Ÿ HTML
            if (item.type === 'transport' || item.type === 'info') {
                div.className = `glass-card mb-4 ${item.color ? 'border-l-4 border-'+item.color+'-500' : ''}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-bold text-gray-800 text-lg">${item.title}</h3>
                        ${item.time ? `<span class="text-lg font-bold text-${item.color || 'gray'}-600">${item.time}</span>` : `<i class="${item.icon} text-xl text-gray-400"></i>`}
                    </div>
                    <div class="text-sm text-gray-500">${item.desc || item.content}</div>
                    ${item.link ? `<a href="${item.link}" target="_blank" class="mt-2 block text-xs text-${item.color || 'blue'}-500 underline">åœ°åœ–/é€£çµ</a>` : ''}
                `;
            } 
            else if (item.type === 'flight') {
                div.className = "flight-card rounded-2xl p-5 mb-4 relative overflow-hidden";
                div.innerHTML = `
                    <div class="relative z-10">
                        <div class="flex justify-between mb-4 border-b border-white/20 pb-2"><span class="font-mono text-xl font-bold">${item.code}</span><span class="text-xs bg-white/20 px-2 py-1 rounded">${item.airline}</span></div>
                        <div class="flex justify-between text-center mb-4"><div><div class="text-3xl font-bold">${item.dep.code}</div><div class="text-xs opacity-70">${item.dep.time}</div></div><div class="text-xs opacity-50 pt-2">${item.dur}<br>âœˆ</div><div><div class="text-3xl font-bold">${item.arr.code}</div><div class="text-xs opacity-70">${item.arr.time}</div></div></div>
                        <div class="bg-black/20 rounded-xl p-3 mb-3 text-sm space-y-1">
                            <div class="flex justify-between"><span>ğŸ’º Seat</span><span class="font-bold">${item.seat}</span></div>
                            <div class="flex justify-between"><span>ğŸ´ Meal</span><span class="font-bold text-xs">${item.meal}</span></div>
                            ${item.drinks ? `<div class="border-t border-white/10 pt-1 mt-1"><span class="text-[10px] opacity-70 block mb-1">ğŸ¸ Drinks:</span>${item.drinks.map(d=>`<span class="block text-xs">â€¢ ${d}</span>`).join('')}</div>` : ''}
                        </div>
                        <div class="bg-[#F8F4E3] text-[#3E3A35] rounded-xl p-3 flex justify-between items-center cursor-pointer active:scale-95 transition" onclick="copyCode('${item.bookingRef}')">
                            <div><div class="text-[10px] font-bold">BOOKING REF</div><div class="font-mono font-bold">${item.bookingRef}</div><div class="text-[10px]">${item.passenger}</div></div>
                            <i class="far fa-copy text-xl opacity-50"></i>
                        </div>
                        ${item.manageUrl ? `<a href="${item.manageUrl}" target="_blank" class="mt-3 block text-center text-xs border border-white/30 rounded py-2 hover:bg-white/10">è¡Œç¨‹ç®¡ç†</a>` : ''}
                    </div>
                `;
            }
            else if (item.type === 'bus' || item.type === 'train') {
                 div.className = item.type === 'bus' ? "bus-card rounded-2xl p-4 mb-4" : "train-card rounded-2xl p-4 mb-4";
                 div.innerHTML = `
                    <div class="flex justify-between mb-3 pb-2 border-b border-white/20"><span class="font-bold text-lg"><i class="fas fa-${item.type}"></i> ${item.title}</span></div>
                    <div class="flex justify-between text-center mb-3">
                        <div class="text-left">${item.dep}</div><i class="fas fa-arrow-right opacity-50"></i><div class="text-right">${item.arr}</div>
                    </div>
                    <div class="bg-black/10 rounded p-2 flex justify-between text-sm">
                        <span>${item.seat || item.note}</span>
                        <span>${item.price || ''}</span>
                    </div>
                    ${item.link ? `<a href="${item.link}" target="_blank" class="mt-2 block text-center text-xs bg-white/20 py-1 rounded">é–‹å•Ÿé€£çµ</a>` : ''}
                 `;
            }
            else if (item.type === 'hotel' || item.type === 'snoopy' || item.type === 'spot') {
                 div.className = item.type === 'snoopy' ? "snoopy-card rounded-2xl p-4 mb-4" : `glass-card mb-4 ${item.color ? 'border-l-4 border-'+item.color+'-500' : ''}`;
                 if (item.type === 'hotel') div.style.borderLeft = "4px solid #1e40af";
                 div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div><h3 class="font-bold text-lg text-gray-800">${item.title}</h3><div class="text-xs text-gray-500">${item.desc}</div></div>
                        ${item.type === 'hotel' ? '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">Hotel</span>' : ''}
                         ${item.icon && item.type !== 'hotel' ? `<i class="${item.icon} text-xl text-${item.color || 'gray'}-500"></i>` : ''}
                    </div>
                    ${item.bookingRef ? `<div class="mt-2 flex justify-between bg-gray-50 p-2 rounded border border-gray-200 text-sm"><span>Ref: <span class="font-mono font-bold">${item.bookingRef}</span></span><button onclick="copyCode('${item.bookingRef}')"><i class="far fa-copy"></i></button></div>` : ''}
                    ${item.price ? `<div class="mt-1 text-right text-xs font-bold text-gray-600">${item.price}</div>` : ''}
                    ${item.link ? `<a href="${item.link}" target="_blank" class="mt-3 block w-full text-center bg-gray-100 text-gray-600 text-xs py-2 rounded hover:bg-gray-200 transition">${item.linkText || 'æŸ¥çœ‹ä½ç½®'}</a>` : ''}
                 `;
            }
            else if (item.type === 'rent') {
                div.className = "glass-card rent-card mb-4";
                div.innerHTML = `
                    <div class="flex justify-between"><h3 class="font-bold text-gray-800">${item.title}</h3><span class="bg-red-600 text-white text-xs px-2 py-1 rounded">${item.car}</span></div>
                    <div class="bg-gray-50 p-3 rounded mt-2 text-sm space-y-2">
                         <div class="flex justify-between"><span>å–: ${item.pickup}</span><span>é‚„: ${item.return}</span></div>
                         <div class="flex justify-between items-center pt-2 border-t"><span>é ç´„è™Ÿ: <span class="font-mono font-bold text-red-600">${item.ref}</span></span><button onclick="copyCode('${item.ref}')"><i class="far fa-copy"></i></button></div>
                         <div class="flex justify-between"><span>è²»ç”¨</span><span>${item.price}</span></div>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="copyCode('${item.mapcode}')" class="flex-1 bg-blue-50 text-blue-600 text-xs py-2 rounded">MapCode</button>
                        <a href="${item.pdf}" target="_blank" class="flex-1 bg-gray-800 text-white text-xs py-2 rounded text-center">PDF</a>
                    </div>
                    <a href="${item.link}" target="_blank" class="mt-2 block w-full text-center bg-red-600 text-white text-xs py-2 rounded">å°èˆª</a>
                `;
            }
            else if (item.type === 'luger') {
                div.className = "luger-card rounded-2xl p-5 mb-4 shadow-xl";
                div.innerHTML = `
                    <div class="flex justify-between border-b border-[#d4af37]/30 pb-2 mb-3"><span class="text-xs tracking-widest">RESERVATION</span><span class="font-bold text-xl">${item.time}</span></div>
                    <h2 class="font-serif text-2xl font-bold text-[#f3e5ab] mb-1">${item.title}</h2>
                    <div class="bg-black/20 p-3 rounded border border-[#d4af37]/20 mb-3">
                         <div class="flex justify-between items-center"><span>Ref: <span class="font-mono font-bold">${item.bookingRef}</span></span><button onclick="copyCode('${item.bookingRef}')"><i class="far fa-copy"></i></button></div>
                         <div class="text-xs mt-1 opacity-80">${item.details}</div>
                    </div>
                    <div class="text-[10px] bg-[#d4af37]/10 p-2 rounded text-center space-y-1">
                        <div class="font-bold text-[#d4af37]">MENU NOTE</div>
                        <div class="grid grid-cols-2 gap-x-4 text-left opacity-80">
                           <span>â€¢ Steak for Two</span><span>â€¢ Bacon</span>
                           <span>â€¢ German Potatoes</span><span>â€¢ Creamed Spinach</span>
                        </div>
                        <div class="pt-1 mt-1 border-t border-[#d4af37]/20 opacity-60">Rare / Medium-Rare / Medium</div>
                    </div>
                     <div class="flex gap-2 mt-3">
                         ${item.manageUrl ? `<a href="${item.manageUrl}" target="_blank" class="flex-1 text-center text-xs border border-[#d4af37]/50 text-[#d4af37] py-2 rounded hover:bg-[#d4af37] hover:text-[#4a0e0e] transition">TableCheck</a>` : ''}
                         <a href="${item.link}" target="_blank" class="flex-1 text-center text-xs border border-[#d4af37]/50 text-[#d4af37] py-2 rounded hover:bg-[#d4af37] hover:text-[#4a0e0e] transition">Map</a>
                     </div>
                `;
            }
             else if (item.type === 'sushi') {
                div.className = "sushi-card rounded-2xl p-5 mb-4 shadow-xl";
                div.innerHTML = `
                    <div class="flex justify-between border-b border-[#e6cda3]/30 pb-2 mb-3"><span class="text-xs tracking-widest">RESERVATION</span><span class="font-bold text-xl">${item.time}</span></div>
                    <h2 class="font-serif text-2xl font-bold text-white mb-1">${item.title}</h2>
                     <div class="text-xs text-yellow-500 mb-3">â˜… ${item.rating}</div>
                    <div class="bg-[#333]/50 p-3 rounded border border-[#e6cda3]/20 mb-3">
                         <div class="flex justify-between items-center"><span>Ref: <span class="font-mono font-bold">${item.bookingRef}</span></span><button onclick="copyCode('${item.bookingRef}')"><i class="far fa-copy"></i></button></div>
                         <div class="text-xs mt-1 opacity-80">${item.details}</div>
                    </div>
                     <div class="flex gap-2 mt-3">
                         ${item.manageUrl ? `<a href="${item.manageUrl}" target="_blank" class="flex-1 text-center text-xs border border-[#e6cda3]/50 text-[#e6cda3] py-2 rounded hover:bg-[#e6cda3] hover:text-black transition">TableCheck</a>` : ''}
                         <a href="${item.link}" target="_blank" class="flex-1 text-center text-xs border border-[#e6cda3]/50 text-[#e6cda3] py-2 rounded hover:bg-[#e6cda3] hover:text-black transition">Map</a>
                     </div>
                `;
            }
            else if (item.type === 'fuji-forecast') {
                div.className = "fuji-forecast-card rounded-2xl p-4 mb-4 shadow-lg text-center";
                div.innerHTML = `
                    <i class="fas fa-mountain fuji-bg"></i>
                    <div class="relative z-10">
                        <h3 class="font-bold text-lg mb-1">å¯Œå£«å±±èƒ½è¦‹åº¦</h3>
                        <span id="fuji-status-badge" class="text-xs bg-white/20 px-2 py-0.5 rounded">Loading...</span>
                        <div class="flex justify-center gap-2 mt-3">
                            <a href="https://fuji-san.info/zh-tw/index.html" target="_blank" class="bg-white text-blue-600 text-xs px-3 py-2 rounded font-bold">å®˜æ–¹æŒ‡æ•¸</a>
                            <a href="https://live.fujigoko.tv/?n=3&t=14&b=&u=&e=&c=" target="_blank" class="bg-black/20 text-white text-xs px-3 py-2 rounded">Live Cam</a>
                        </div>
                    </div>
                `;
            }
            else if (item.type === 'weather-plan') {
                div.innerHTML = `
                    <div class="flex justify-center mb-3 mt-6"><div class="bg-gray-100 p-1 rounded-xl flex text-sm font-bold">
                        <button onclick="togglePlan('sun')" id="btn-plan-sun" class="weather-toggle-btn active-sun px-4 py-1 rounded-lg">â˜€ï¸ æ™´å¤©</button>
                        <button onclick="togglePlan('rain')" id="btn-plan-rain" class="weather-toggle-btn px-4 py-1 rounded-lg text-gray-400">â˜” é›¨å¤©</button>
                    </div></div>
                    <div id="plan-sun" class="weather-plan active bg-orange-50 border border-orange-100 rounded-xl p-3 mb-4">
                        <h4 class="font-bold text-orange-800 text-sm mb-2">çµ•æ™¯æ”å½±</h4>
                        ${item.sun.map(p => `<div class="flex gap-2 text-sm mb-2"><div class="w-1.5 h-1.5 mt-1.5 rounded-full bg-orange-400 flex-shrink-0"></div><div><div class="font-bold text-gray-700">${p.title}</div><div class="text-xs text-gray-500">${p.desc}</div>${p.link?`<a href="${p.link}" class="text-xs text-orange-500 underline">Map</a>`:''}</div></div>`).join('')}
                    </div>
                    <div id="plan-rain" class="weather-plan bg-blue-50 border border-blue-100 rounded-xl p-3 mb-4">
                        <h4 class="font-bold text-blue-800 text-sm mb-2">è—æ–‡èˆ‡è³¼ç‰©</h4>
                        ${item.rain.map(p => `<div class="flex gap-2 text-sm mb-2"><div class="w-1.5 h-1.5 mt-1.5 rounded-full bg-blue-400 flex-shrink-0"></div><div><div class="font-bold text-gray-700">${p.title}</div><div class="text-xs text-gray-500">${p.desc}</div>${p.link?`<a href="${p.link}" class="text-xs text-blue-500 underline">Map</a>`:''}</div></div>`).join('')}
                    </div>
                `;
            }
            else if (item.type === 'photo-guide') {
                 div.className = "bg-gradient-to-r from-amber-50 to-blue-50 border border-gray-200 rounded-xl p-3 mb-4 shadow-sm";
                 div.innerHTML = `<h3 class="font-bold text-gray-800 text-sm mb-2"><i class="fas fa-lightbulb text-yellow-500"></i> æ”å½±å…‰ç·šæŒ‡å—</h3><div class="text-xs space-y-1"><div><span class="font-bold text-amber-600">AM:</span> æ²³å£æ¹–ã€å¿é‡å…«æµ·</div><div><span class="font-bold text-blue-600">PM:</span> è¥¿æ¹–ã€æœ¬æ –æ¹–</div></div>`;
            }
            else if (item.type === 'divider') {
                div.className = "relative py-4";
                div.innerHTML = `<div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center"><span class="bg-slate-50 px-4 text-sm text-gray-500 font-bold">${item.text}</span></div>`;
            }

            return div;
        }

        function renderWeather(container, w) {
            const div = document.createElement('div');
            div.className = "weather-widget rounded-xl p-3 flex items-center justify-between mb-4";
            div.innerHTML = `
                <div class="flex items-center gap-3"><div class="text-2xl"><i class="${w.icon}"></i></div><div><div class="font-bold text-sm text-gray-800">${w.loc}</div><div class="text-xs text-gray-500">${w.status}</div></div></div>
                <div class="text-right"><div class="font-bold text-lg text-gray-800">${w.temp}</div></div>
            `;
            container.appendChild(div);
        }

        function renderTabContent(day, role, container) {
            // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
            document.getElementById(`tab-${day}-brother`).className = role === 'brother' ? "tab-btn active flex-1 py-2 rounded-lg transition-all font-bold shadow-sm" : "tab-btn flex-1 py-2 rounded-lg text-gray-500 hover:text-gray-700 transition-all";
            document.getElementById(`tab-${day}-mom`).className = role === 'mom' ? "tab-btn active flex-1 py-2 rounded-lg transition-all font-bold shadow-sm" : "tab-btn flex-1 py-2 rounded-lg text-gray-500 hover:text-gray-700 transition-all";
            
            container.innerHTML = '';
            tripData[day].tabs[role].forEach(item => {
                container.appendChild(createCard(item));
            });
        }

        // ==========================================
        // 3. åŠŸèƒ½å‡½å¼ (åˆ‡æ›ã€è¨˜å¸³ã€æ¸…å–®)
        // ==========================================
        function switchDate(viewId) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('#date-nav button').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white', 'shadow-lg');
                if (btn.id === `btn-${viewId}`) {
                    btn.classList.add('active');
                    if(viewId === 'list') btn.classList.add('bg-red-500', 'text-white');
                    else if(viewId === 'budget') btn.classList.add('bg-green-600', 'text-white');
                    else btn.classList.add('bg-blue-600', 'text-white');
                } else {
                     // Reset special buttons
                     if (btn.id === 'btn-list') { btn.classList.add('bg-red-50', 'text-red-500'); }
                     else if (btn.id === 'btn-budget') { btn.classList.add('bg-green-50', 'text-green-600'); }
                     else { btn.classList.add('bg-gray-100', 'text-gray-400'); }
                }
            });

            renderApp(viewId);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function switchTab(day, role) {
            const container = document.getElementById(`tab-content-${day}`);
            renderTabContent(day, role, container);
        }

        function togglePlan(type) {
            const sun = document.getElementById('plan-sun');
            const rain = document.getElementById('plan-rain');
            const btnSun = document.getElementById('btn-plan-sun');
            const btnRain = document.getElementById('btn-plan-rain');

            if (type === 'sun') {
                sun.style.display = 'block'; rain.style.display = 'none';
                btnSun.classList.add('active-sun'); btnSun.classList.remove('text-gray-400');
                btnRain.classList.remove('active-rain'); btnRain.classList.add('text-gray-400');
            } else {
                sun.style.display = 'none'; rain.style.display = 'block';
                btnRain.classList.add('active-rain'); btnRain.classList.remove('text-gray-400');
                btnSun.classList.remove('active-sun'); btnSun.classList.add('text-gray-400');
            }
        }

        // --- Packing List ---
        const defaultList = ["è­·ç…§", "é§•ç…§(å°/æ—¥)", "æ—¥å¹£ç¾é‡‘", "Visit Japan Web", "è»Šç¥¨/Suica", "Simå¡", "è¡Œå‹•é›»æº/ç·š", "ç›¸æ©Ÿ", "ç¾½çµ¨å¤–å¥—", "ç™¼ç†±è¡£ x3", "å…§è¤² x3", "è¥ªå­ x3", "ç‰™åˆ·/æ´—é¢ä¹³", "å¸¸å‚™è—¥"];
        function renderPackingList(container) {
            const saved = JSON.parse(localStorage.getItem('tokyoList')) || defaultList.map(t => ({text: t, checked: false}));
            
            const wrapper = document.createElement('div');
            wrapper.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100";
            wrapper.innerHTML = `
                <h2 class="font-bold text-lg mb-3 flex items-center gap-2 text-red-500"><i class="fas fa-suitcase"></i> è¡Œææ¸…å–®</h2>
                <div class="flex gap-2 mb-4"><input type="text" id="add-item" placeholder="æ–°å¢..." class="flex-1 border rounded px-3 py-2 text-sm"><button onclick="addListItem()" class="bg-red-500 text-white px-4 rounded"><i class="fas fa-plus"></i></button></div>
                <div id="list-items" class="space-y-2"></div>
            `;
            container.appendChild(wrapper);
            
            const listDiv = wrapper.querySelector('#list-items');
            saved.forEach((item, i) => {
                const row = document.createElement('div');
                row.className = `check-item flex items-center gap-3 p-2 rounded border ${item.checked ? 'checked bg-gray-50' : 'bg-white'}`;
                row.onclick = () => { item.checked = !item.checked; localStorage.setItem('tokyoList', JSON.stringify(saved)); switchDate('list'); };
                row.innerHTML = `<div class="w-5 h-5 rounded border flex items-center justify-center ${item.checked ? 'bg-green-500 border-green-500 text-white' : ''}">${item.checked ? 'âœ“' : ''}</div><span class="flex-1 text-sm">${item.text}</span><button onclick="event.stopPropagation(); removeListItem(${i})" class="text-gray-300 px-2">âœ•</button>`;
                listDiv.appendChild(row);
            });
        }
        window.addListItem = () => {
            const val = document.getElementById('add-item').value;
            if(!val) return;
            const saved = JSON.parse(localStorage.getItem('tokyoList')) || defaultList.map(t => ({text: t, checked: false}));
            saved.push({text: val, checked: false});
            localStorage.setItem('tokyoList', JSON.stringify(saved));
            switchDate('list');
        };
        window.removeListItem = (i) => {
            const saved = JSON.parse(localStorage.getItem('tokyoList'));
            saved.splice(i, 1);
            localStorage.setItem('tokyoList', JSON.stringify(saved));
            switchDate('list');
        };

        // --- Budget ---
        function renderBudget(container) {
            const expenses = JSON.parse(localStorage.getItem('tokyoBudget')) || [];
            let totalJ = 0, totalT = 0;
            let cashJpy = 0;
            
            expenses.forEach(e => { 
                const j = parseFloat(e.j) || 0;
                const t = parseFloat(e.t) || 0;
                // å¦‚æœæœ‰å°å¹£ç”¨å°å¹£ï¼Œæ²’æœ‰å‰‡æ—¥å¹£æ›ç®—
                totalT += t > 0 ? t : Math.round(j * 0.22);
                
                // ç¾é‡‘èˆ‡è¥¿ç“œå¡ç´¯ç©æ—¥å¹£
                if(e.c === 'ç¾é‡‘' || e.c === 'è¥¿ç“œå¡') cashJpy += j;
            });

            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-5 rounded-2xl shadow-lg text-white mb-4">
                    <div class="flex justify-between items-start">
                        <div><h3 class="text-xs opacity-80 mb-1">ç¸½æ”¯å‡º (ç´„å°å¹£)</h3><div class="text-3xl font-bold">NT$ ${totalT.toLocaleString()}</div></div>
                        <div class="text-right"><h3 class="text-xs opacity-80 mb-1">ç¾é‡‘/è¥¿ç“œå¡</h3><div class="text-xl font-bold">Â¥ ${cashJpy.toLocaleString()}</div></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">
                    <h4 class="font-bold text-gray-700 mb-3 text-sm">æ–°å¢æ¶ˆè²»</h4>
                    <div class="space-y-3">
                        <input id="exp-name" placeholder="æ¶ˆè²»é …ç›® (å¦‚: æ™šé¤)" class="w-full border rounded-lg px-3 py-2.5 text-sm">
                        <div class="flex flex-col gap-2">
                             <input id="exp-j" type="number" placeholder="æ—¥å¹£ Â¥ (è‡ªå‹•æ›ç®—)" class="w-full border rounded-lg px-3 py-2.5 text-sm" oninput="calcTwd()">
                             <input id="exp-t" type="number" placeholder="å°å¹£ NT$" class="w-full border rounded-lg px-3 py-2.5 text-sm">
                        </div>
                        <div class="grid grid-cols-3 gap-2" id="pay-opts">
                             ${['Cube','å°æ–°','ä¸­ä¿¡','è¥¿ç“œå¡','ç¾é‡‘'].map(m => `<button onclick="setPay('${m}')" class="pay-btn text-xs py-2 rounded-lg bg-gray-50 flex-1">${m}</button>`).join('')}
                        </div>
                        <input type="hidden" id="exp-card">
                        <button onclick="addExp()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold shadow-md mt-2">åŠ å…¥è¨˜å¸³</button>
                    </div>
                </div>
                <div class="space-y-3 pb-20">
                    ${expenses.map((e, i) => `
                        <div class="bg-white p-3 rounded-xl border shadow-sm flex justify-between items-center">
                            <div><div class="font-bold text-gray-800">${e.n}</div><div class="text-xs text-gray-500">${e.c}</div></div>
                            <div class="text-right"><div class="font-bold">Â¥${e.j}</div><div class="text-xs text-gray-400">NT$${e.t}</div></div>
                            <button onclick="delExp(${i})" class="ml-2 text-gray-300"><i class="fas fa-trash"></i></button>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(wrapper);
            // Default select
            setPay('ç¾é‡‘');
        }
        window.calcTwd = () => { document.getElementById('exp-t').value = Math.round(document.getElementById('exp-j').value * 0.22); };
        window.setPay = (m) => {
            document.getElementById('exp-card').value = m;
            document.querySelectorAll('.pay-btn').forEach(b => {
                b.classList.remove('active', 'bg-green-600', 'text-white');
                b.classList.add('bg-gray-50', 'text-gray-500');
                if(b.innerText === m) {
                    b.classList.remove('bg-gray-50', 'text-gray-500');
                    b.classList.add('active', 'bg-green-600', 'text-white');
                }
            });
        };
        window.addExp = () => {
            const n = document.getElementById('exp-name').value;
            const j = document.getElementById('exp-j').value || 0;
            const t = document.getElementById('exp-t').value || 0;
            const c = document.getElementById('exp-card').value;
            if(!n) return;
            const exps = JSON.parse(localStorage.getItem('tokyoBudget')) || [];
            exps.push({n, j, t, c});
            localStorage.setItem('tokyoBudget', JSON.stringify(exps));
            switchDate('budget');
        };
        window.delExp = (i) => {
            const exps = JSON.parse(localStorage.getItem('tokyoBudget'));
            exps.splice(i, 1);
            localStorage.setItem('tokyoBudget', JSON.stringify(exps));
            switchDate('budget');
        };

        // Utils
        function copyCode(text) { navigator.clipboard.writeText(text).then(() => showToast(`å·²è¤‡è£½ï¼š${text}`)); }
        function showToast(msg) {
            const div = document.createElement('div');
            div.className = "toast-msg bg-black/80 text-white px-4 py-2 rounded-full fixed bottom-10 left-1/2 -translate-x-1/2 text-sm z-50";
            div.innerHTML = `<i class="fas fa-check mr-2"></i>${msg}`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2000);
        }

        // Init
        const btnContainer = document.getElementById('date-nav');
        const dayList = ['list', 'budget', 'day1', 'day2', 'day3', 'day4', 'day5'];
        
        dayList.forEach(id => {
            // HTML already has buttons
        });

        // Fetch Weather
        async function initWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.49&longitude=138.76&current=cloud_cover');
                const data = await res.json();
                const el = document.getElementById('fuji-status-badge');
                if(el) el.innerText = `${data.current.cloud_cover}% é›²é‡`;
            } catch(e){}
        }
        initWeather();
        
        switchDate('day1'); 

    </script>
</body>
</html>
// ==========================================
        // 2. æ ¸å¿ƒæ¸²æŸ“å¼•æ“
        // ==========================================
        function renderApp(viewId) {
            const container = document.getElementById('main-container');
            container.innerHTML = '';

            if (viewId === 'list') { renderPackingList(container); return; }
            if (viewId === 'budget') { renderBudget(container); return; }

            const dayData = tripData[viewId];
            if (!dayData) return;

            // æ¸²æŸ“å¤©æ°£
            if(dayData.weather) renderWeather(container, dayData.weather);

            // æ¸²æŸ“å…±ç”¨è¡Œç¨‹
            if (dayData.items) dayData.items.forEach(item => container.appendChild(createCard(item)));

            // æ¸²æŸ“åˆ†é è¡Œç¨‹ (å¦‚ Day 2, Day 5)
            if (dayData.tabs) {
                const tabContainer = document.createElement('div');
                tabContainer.className = "bg-gray-200 p-1 rounded-xl flex text-sm font-medium mt-4 mb-4";
                tabContainer.innerHTML = `
                    <button onclick="switchTab('${viewId}', 'brother')" id="tab-${viewId}-brother" class="tab-btn active flex-1 py-2 rounded-lg transition-all">å“¥å“¥</button>
                    <button onclick="switchTab('${viewId}', 'mom')" id="tab-${viewId}-mom" class="tab-btn flex-1 py-2 rounded-lg text-gray-500 transition-all">åª½åª½</button>
                `;
                container.appendChild(tabContainer);

                const contentDiv = document.createElement('div');
                contentDiv.id = `tab-content-${viewId}`;
                container.appendChild(contentDiv);
                
                // é è¨­é¡¯ç¤ºå“¥å“¥
                renderTabContent(viewId, 'brother', contentDiv);
            }

            // Day 2 ç‰¹æ®Š: æ··åˆäº† tabs å’Œ jointItems
            if(dayData.jointItems) {
                 dayData.jointItems.forEach(item => container.appendChild(createCard(item)));
            }
        }

        function createCard(item) {
            const div = document.createElement('div');
            
            // æ ¹æ“šé¡å‹ç”¢ç”Ÿ HTML
            if (item.type === 'transport' || item.type === 'info') {
                div.className = `glass-card mb-4 ${item.color ? 'border-l-4 border-'+item.color+'-500' : ''}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-bold text-gray-800 text-lg">${item.title}</h3>
                        ${item.time ? `<span class="text-lg font-bold text-${item.color || 'gray'}-600">${item.time}</span>` : `<i class="${item.icon} text-xl text-gray-400"></i>`}
                    </div>
                    <div class="text-sm text-gray-500">${item.desc || item.content}</div>
                    ${item.link ? `<a href="${item.link}" target="_blank" class="mt-2 block text-xs text-${item.color || 'blue'}-500 underline">åœ°åœ–/é€£çµ</a>` : ''}
                `;
            } 
            else if (item.type === 'flight') {
                div.className = "flight-card rounded-2xl p-5 mb-4 relative overflow-hidden";
                div.innerHTML = `
                    <div class="relative z-10">
                        <div class="flex justify-between mb-4 border-b border-white/20 pb-2"><span class="font-mono text-xl font-bold">${item.code}</span><span class="text-xs bg-white/20 px-2 py-1 rounded">${item.airline}</span></div>
                        <div class="flex justify-between text-center mb-4"><div><div class="text-3xl font-bold">${item.dep.code}</div><div class="text-xs opacity-70">${item.dep.time}</div></div><div class="text-xs opacity-50 pt-2">${item.dur}<br>âœˆ</div><div><div class="text-3xl font-bold">${item.arr.code}</div><div class="text-xs opacity-70">${item.arr.time}</div></div></div>
                        <div class="bg-black/20 rounded-xl p-3 mb-3 text-sm space-y-1">
                            <div class="flex justify-between"><span>ğŸ’º Seat</span><span class="font-bold">${item.seat}</span></div>
                            <div class="flex justify-between"><span>ğŸ´ Meal</span><span class="font-bold text-xs">${item.meal}</span></div>
                            ${item.drinks ? `<div class="border-t border-white/10 pt-1 mt-1"><span class="text-[10px] opacity-70 block mb-1">ğŸ¸ Drinks:</span>${item.drinks.map(d=>`<span class="block text-xs">â€¢ ${d}</span>`).join('')}</div>` : ''}
                        </div>
                        <div class="bg-[#F8F4E3] text-[#3E3A35] rounded-xl p-3 flex justify-between items-center cursor-pointer active:scale-95 transition" onclick="copyCode('${item.bookingRef}')">
                            <div><div class="text-[10px] font-bold">BOOKING REF</div><div class="font-mono font-bold">${item.bookingRef}</div><div class="text-[10px]">${item.passenger}</div></div>
                            <i class="far fa-copy text-xl opacity-50"></i>
                        </div>
                        ${item.manageUrl ? `<a href="${item.manageUrl}" target="_blank" class="mt-3 block text-center text-xs border border-white/30 rounded py-2 hover:bg-white/10">è¡Œç¨‹ç®¡ç†</a>` : ''}
                    </div>
                `;
            }
            else if (item.type === 'bus' || item.type === 'train') {
                 div.className = item.type === 'bus' ? "bus-card rounded-2xl p-4 mb-4" : "train-card rounded-2xl p-4 mb-4";
                 div.innerHTML = `
                    <div class="flex justify-between mb-3 pb-2 border-b border-white/20"><span class="font-bold text-lg"><i class="fas fa-${item.type}"></i> ${item.title}</span></div>
                    <div class="flex justify-between text-center mb-3">
                        <div class="text-left">${item.dep}</div><i class="fas fa-arrow-right opacity-50"></i><div class="text-right">${item.arr}</div>
                    </div>
                    <div class="bg-black/10 rounded p-2 flex justify-between text-sm">
                        <span>${item.seat || item.note}</span>
                        <span>${item.price || ''}</span>
                    </div>
                    ${item.link ? `<a href="${item.link}" target="_blank" class="mt-2 block text-center text-xs bg-white/20 py-1 rounded">é–‹å•Ÿé€£çµ</a>` : ''}
                 `;
            }
            else if (item.type === 'hotel' || item.type === 'snoopy' || item.type === 'spot') {
                 div.className = item.type === 'snoopy' ? "snoopy-card rounded-2xl p-4 mb-4" : `glass-card mb-4 ${item.color ? 'border-l-4 border-'+item.color+'-500' : ''}`;
                 if (item.type === 'hotel') div.style.borderLeft = "4px solid #1e40af";
                 div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div><h3 class="font-bold text-lg text-gray-800">${item.title}</h3><div class="text-xs text-gray-500">${item.desc}</div></div>
                        ${item.type === 'hotel' ? '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">Hotel</span>' : ''}
                         ${item.icon && item.type !== 'hotel' ? `<i class="${item.icon} text-xl text-${item.color || 'gray'}-500"></i>` : ''}
                    </div>
                    ${item.bookingRef ? `<div class="mt-2 flex justify-between bg-gray-50 p-2 rounded border border-gray-200 text-sm"><span>Ref: <span class="font-mono font-bold">${item.bookingRef}</span></span><button onclick="copyCode('${item.bookingRef}')"><i class="far fa-copy"></i></button></div>` : ''}
                    ${item.price ? `<div class="mt-1 text-right text-xs font-bold text-gray-600">${item.price}</div>` : ''}
                    ${item.link ? `<a href="${item.link}" target="_blank" class="mt-3 block w-full text-center bg-gray-100 text-gray-600 text-xs py-2 rounded hover:bg-gray-200 transition">${item.linkText || 'æŸ¥çœ‹ä½ç½®'}</a>` : ''}
                 `;
            }
            else if (item.type === 'rent') {
                div.className = "glass-card rent-card mb-4";
                div.innerHTML = `
                    <div class="flex justify-between"><h3 class="font-bold text-gray-800">${item.title}</h3><span class="bg-red-600 text-white text-xs px-2 py-1 rounded">${item.car}</span></div>
                    <div class="bg-gray-50 p-3 rounded mt-2 text-sm space-y-2">
                         <div class="flex justify-between"><span>å–: ${item.pickup}</span><span>é‚„: ${item.return}</span></div>
                         <div class="flex justify-between items-center pt-2 border-t"><span>é ç´„è™Ÿ: <span class="font-mono font-bold text-red-600">${item.ref}</span></span><button onclick="copyCode('${item.ref}')"><i class="far fa-copy"></i></button></div>
                         <div class="flex justify-between"><span>è²»ç”¨</span><span>${item.price}</span></div>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="copyCode('${item.mapcode}')" class="flex-1 bg-blue-50 text-blue-600 text-xs py-2 rounded">MapCode</button>
                        <a href="${item.pdf}" target="_blank" class="flex-1 bg-gray-800 text-white text-xs py-2 rounded text-center">PDF</a>
                    </div>
                    <a href="${item.link}" target="_blank" class="mt-2 block w-full text-center bg-red-600 text-white text-xs py-2 rounded">å°èˆª</a>
                `;
            }
            else if (item.type === 'luger') {
                div.className = "luger-card rounded-2xl p-5 mb-4 shadow-xl";
                div.innerHTML = `
                    <div class="flex justify-between border-b border-[#d4af37]/30 pb-2 mb-3"><span class="text-xs tracking-widest">RESERVATION</span><span class="font-bold text-xl">${item.time}</span></div>
                    <h2 class="font-serif text-2xl font-bold text-[#f3e5ab] mb-1">${item.title}</h2>
                    <div class="bg-black/20 p-3 rounded border border-[#d4af37]/20 mb-3">
                         <div class="flex justify-between items-center"><span>Ref: <span class="font-mono font-bold">${item.bookingRef}</span></span><button onclick="copyCode('${item.bookingRef}')"><i class="far fa-copy"></i></button></div>
                         <div class="text-xs mt-1 opacity-80">${item.details}</div>
                    </div>
                    <div class="text-[10px] bg-[#d4af37]/10 p-2 rounded text-center space-y-1">
                        <div class="font-bold text-[#d4af37]">MENU NOTE</div>
                        <div class="grid grid-cols-2 gap-x-4 text-left opacity-80">
                           <span>â€¢ Steak for Two</span><span>â€¢ Bacon</span>
                           <span>â€¢ German Potatoes</span><span>â€¢ Creamed Spinach</span>
                        </div>
                        <div class="pt-1 mt-1 border-t border-[#d4af37]/20 opacity-60">Rare / Medium-Rare / Medium</div>
                    </div>
                     <div class="flex gap-2 mt-3">
                         ${item.manageUrl ? `<a href="${item.manageUrl}" target="_blank" class="flex-1 text-center text-xs border border-[#d4af37]/50 text-[#d4af37] py-2 rounded hover:bg-[#d4af37] hover:text-[#4a0e0e] transition">TableCheck</a>` : ''}
                         <a href="${item.link}" target="_blank" class="flex-1 text-center text-xs border border-[#d4af37]/50 text-[#d4af37] py-2 rounded hover:bg-[#d4af37] hover:text-[#4a0e0e] transition">Map</a>
                     </div>
                `;
            }
             else if (item.type === 'sushi') {
                div.className = "sushi-card rounded-2xl p-5 mb-4 shadow-xl";
                div.innerHTML = `
                    <div class="flex justify-between border-b border-[#e6cda3]/30 pb-2 mb-3"><span class="text-xs tracking-widest">RESERVATION</span><span class="font-bold text-xl">${item.time}</span></div>
                    <h2 class="font-serif text-2xl font-bold text-white mb-1">${item.title}</h2>
                     <div class="text-xs text-yellow-500 mb-3">â˜… ${item.rating}</div>
                    <div class="bg-[#333]/50 p-3 rounded border border-[#e6cda3]/20 mb-3">
                         <div class="flex justify-between items-center"><span>Ref: <span class="font-mono font-bold">${item.bookingRef}</span></span><button onclick="copyCode('${item.bookingRef}')"><i class="far fa-copy"></i></button></div>
                         <div class="text-xs mt-1 opacity-80">${item.details}</div>
                    </div>
                     <div class="flex gap-2 mt-3">
                         ${item.manageUrl ? `<a href="${item.manageUrl}" target="_blank" class="flex-1 text-center text-xs border border-[#e6cda3]/50 text-[#e6cda3] py-2 rounded hover:bg-[#e6cda3] hover:text-black transition">TableCheck</a>` : ''}
                         <a href="${item.link}" target="_blank" class="flex-1 text-center text-xs border border-[#e6cda3]/50 text-[#e6cda3] py-2 rounded hover:bg-[#e6cda3] hover:text-black transition">Map</a>
                     </div>
                `;
            }
            else if (item.type === 'fuji-forecast') {
                div.className = "fuji-forecast-card rounded-2xl p-4 mb-4 shadow-lg text-center";
                div.innerHTML = `
                    <i class="fas fa-mountain fuji-bg"></i>
                    <div class="relative z-10">
                        <h3 class="font-bold text-lg mb-1">å¯Œå£«å±±èƒ½è¦‹åº¦</h3>
                        <span id="fuji-status-badge" class="text-xs bg-white/20 px-2 py-0.5 rounded">Loading...</span>
                        <div class="flex justify-center gap-2 mt-3">
                            <a href="https://fuji-san.info/zh-tw/index.html" target="_blank" class="bg-white text-blue-600 text-xs px-3 py-2 rounded font-bold">å®˜æ–¹æŒ‡æ•¸</a>
                            <a href="https://live.fujigoko.tv/?n=3&t=14&b=&u=&e=&c=" target="_blank" class="bg-black/20 text-white text-xs px-3 py-2 rounded">Live Cam</a>
                        </div>
                    </div>
                `;
            }
            else if (item.type === 'weather-plan') {
                div.innerHTML = `
                    <div class="flex justify-center mb-3 mt-6"><div class="bg-gray-100 p-1 rounded-xl flex text-sm font-bold">
                        <button onclick="togglePlan('sun')" id="btn-plan-sun" class="weather-toggle-btn active-sun px-4 py-1 rounded-lg">â˜€ï¸ æ™´å¤©</button>
                        <button onclick="togglePlan('rain')" id="btn-plan-rain" class="weather-toggle-btn px-4 py-1 rounded-lg text-gray-400">â˜” é›¨å¤©</button>
                    </div></div>
                    <div id="plan-sun" class="weather-plan active bg-orange-50 border border-orange-100 rounded-xl p-3 mb-4">
                        <h4 class="font-bold text-orange-800 text-sm mb-2">çµ•æ™¯æ”å½±</h4>
                        ${item.sun.map(p => `<div class="flex gap-2 text-sm mb-2"><div class="w-1.5 h-1.5 mt-1.5 rounded-full bg-orange-400 flex-shrink-0"></div><div><div class="font-bold text-gray-700">${p.title}</div><div class="text-xs text-gray-500">${p.desc}</div>${p.link?`<a href="${p.link}" class="text-xs text-orange-500 underline">Map</a>`:''}</div></div>`).join('')}
                    </div>
                    <div id="plan-rain" class="weather-plan bg-blue-50 border border-blue-100 rounded-xl p-3 mb-4">
                        <h4 class="font-bold text-blue-800 text-sm mb-2">è—æ–‡èˆ‡è³¼ç‰©</h4>
                        ${item.rain.map(p => `<div class="flex gap-2 text-sm mb-2"><div class="w-1.5 h-1.5 mt-1.5 rounded-full bg-blue-400 flex-shrink-0"></div><div><div class="font-bold text-gray-700">${p.title}</div><div class="text-xs text-gray-500">${p.desc}</div>${p.link?`<a href="${p.link}" class="text-xs text-blue-500 underline">Map</a>`:''}</div></div>`).join('')}
                    </div>
                `;
            }
            else if (item.type === 'photo-guide') {
                 div.className = "bg-gradient-to-r from-amber-50 to-blue-50 border border-gray-200 rounded-xl p-3 mb-4 shadow-sm";
                 div.innerHTML = `<h3 class="font-bold text-gray-800 text-sm mb-2"><i class="fas fa-lightbulb text-yellow-500"></i> æ”å½±å…‰ç·šæŒ‡å—</h3><div class="text-xs space-y-1"><div><span class="font-bold text-amber-600">AM:</span> æ²³å£æ¹–ã€å¿é‡å…«æµ·</div><div><span class="font-bold text-blue-600">PM:</span> è¥¿æ¹–ã€æœ¬æ –æ¹–</div></div>`;
            }
            else if (item.type === 'divider') {
                div.className = "relative py-4";
                div.innerHTML = `<div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center"><span class="bg-slate-50 px-4 text-sm text-gray-500 font-bold">${item.text}</span></div>`;
            }

            return div;
        }

        function renderWeather(container, w) {
            const div = document.createElement('div');
            div.className = "weather-widget rounded-xl p-3 flex items-center justify-between mb-4";
            div.innerHTML = `
                <div class="flex items-center gap-3"><div class="text-2xl"><i class="${w.icon}"></i></div><div><div class="font-bold text-sm text-gray-800">${w.loc}</div><div class="text-xs text-gray-500">${w.status}</div></div></div>
                <div class="text-right"><div class="font-bold text-lg text-gray-800">${w.temp}</div></div>
            `;
            container.appendChild(div);
        }

        function renderTabContent(day, role, container) {
            // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
            document.getElementById(`tab-${day}-brother`).className = role === 'brother' ? "tab-btn active flex-1 py-2 rounded-lg transition-all font-bold shadow-sm" : "tab-btn flex-1 py-2 rounded-lg text-gray-500 hover:text-gray-700 transition-all";
            document.getElementById(`tab-${day}-mom`).className = role === 'mom' ? "tab-btn active flex-1 py-2 rounded-lg transition-all font-bold shadow-sm" : "tab-btn flex-1 py-2 rounded-lg text-gray-500 hover:text-gray-700 transition-all";
            
            container.innerHTML = '';
            tripData[day].tabs[role].forEach(item => {
                container.appendChild(createCard(item));
            });
        }

        // ==========================================
        // 3. åŠŸèƒ½å‡½å¼ (åˆ‡æ›ã€è¨˜å¸³ã€æ¸…å–®)
        // ==========================================
        function switchDate(viewId) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('#date-nav button').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white', 'shadow-lg');
                if (btn.id === `btn-${viewId}`) {
                    btn.classList.add('active');
                    if(viewId === 'list') btn.classList.add('bg-red-500', 'text-white');
                    else if(viewId === 'budget') btn.classList.add('bg-green-600', 'text-white');
                    else btn.classList.add('bg-blue-600', 'text-white');
                } else {
                     // Reset special buttons
                     if (btn.id === 'btn-list') { btn.classList.add('bg-red-50', 'text-red-500'); }
                     else if (btn.id === 'btn-budget') { btn.classList.add('bg-green-50', 'text-green-600'); }
                     else { btn.classList.add('bg-gray-100', 'text-gray-400'); }
                }
            });

            renderApp(viewId);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function switchTab(day, role) {
            const container = document.getElementById(`tab-content-${day}`);
            renderTabContent(day, role, container);
        }

        function togglePlan(type) {
            const sun = document.getElementById('plan-sun');
            const rain = document.getElementById('plan-rain');
            const btnSun = document.getElementById('btn-plan-sun');
            const btnRain = document.getElementById('btn-plan-rain');

            if (type === 'sun') {
                sun.style.display = 'block'; rain.style.display = 'none';
                btnSun.classList.add('active-sun'); btnSun.classList.remove('text-gray-400');
                btnRain.classList.remove('active-rain'); btnRain.classList.add('text-gray-400');
            } else {
                sun.style.display = 'none'; rain.style.display = 'block';
                btnRain.classList.add('active-rain'); btnRain.classList.remove('text-gray-400');
                btnSun.classList.remove('active-sun'); btnSun.classList.add('text-gray-400');
            }
        }

        // --- Packing List ---
        const defaultList = ["è­·ç…§", "é§•ç…§(å°/æ—¥)", "æ—¥å¹£ç¾é‡‘", "Visit Japan Web", "è»Šç¥¨/Suica", "Simå¡", "è¡Œå‹•é›»æº/ç·š", "ç›¸æ©Ÿ", "ç¾½çµ¨å¤–å¥—", "ç™¼ç†±è¡£ x3", "å…§è¤² x3", "è¥ªå­ x3", "ç‰™åˆ·/æ´—é¢ä¹³", "å¸¸å‚™è—¥"];
        function renderPackingList(container) {
            const saved = JSON.parse(localStorage.getItem('tokyoList')) || defaultList.map(t => ({text: t, checked: false}));
            
            const wrapper = document.createElement('div');
            wrapper.className = "bg-white p-4 rounded-2xl shadow-sm border border-gray-100";
            wrapper.innerHTML = `
                <h2 class="font-bold text-lg mb-3 flex items-center gap-2 text-red-500"><i class="fas fa-suitcase"></i> è¡Œææ¸…å–®</h2>
                <div class="flex gap-2 mb-4"><input type="text" id="add-item" placeholder="æ–°å¢..." class="flex-1 border rounded px-3 py-2 text-sm"><button onclick="addListItem()" class="bg-red-500 text-white px-4 rounded"><i class="fas fa-plus"></i></button></div>
                <div id="list-items" class="space-y-2"></div>
            `;
            container.appendChild(wrapper);
            
            const listDiv = wrapper.querySelector('#list-items');
            saved.forEach((item, i) => {
                const row = document.createElement('div');
                row.className = `check-item flex items-center gap-3 p-2 rounded border ${item.checked ? 'checked bg-gray-50' : 'bg-white'}`;
                row.onclick = () => { item.checked = !item.checked; localStorage.setItem('tokyoList', JSON.stringify(saved)); switchDate('list'); };
                row.innerHTML = `<div class="w-5 h-5 rounded border flex items-center justify-center ${item.checked ? 'bg-green-500 border-green-500 text-white' : ''}">${item.checked ? 'âœ“' : ''}</div><span class="flex-1 text-sm">${item.text}</span><button onclick="event.stopPropagation(); removeListItem(${i})" class="text-gray-300 px-2">âœ•</button>`;
                listDiv.appendChild(row);
            });
        }
        window.addListItem = () => {
            const val = document.getElementById('add-item').value;
            if(!val) return;
            const saved = JSON.parse(localStorage.getItem('tokyoList')) || defaultList.map(t => ({text: t, checked: false}));
            saved.push({text: val, checked: false});
            localStorage.setItem('tokyoList', JSON.stringify(saved));
            switchDate('list');
        };
        window.removeListItem = (i) => {
            const saved = JSON.parse(localStorage.getItem('tokyoList'));
            saved.splice(i, 1);
            localStorage.setItem('tokyoList', JSON.stringify(saved));
            switchDate('list');
        };

        // --- Budget ---
        function renderBudget(container) {
            const expenses = JSON.parse(localStorage.getItem('tokyoBudget')) || [];
            let totalJ = 0, totalT = 0;
            let cashJpy = 0;
            
            expenses.forEach(e => { 
                const j = parseFloat(e.j) || 0;
                const t = parseFloat(e.t) || 0;
                // å¦‚æœæœ‰å°å¹£ç”¨å°å¹£ï¼Œæ²’æœ‰å‰‡æ—¥å¹£æ›ç®—
                totalT += t > 0 ? t : Math.round(j * 0.22);
                
                // ç¾é‡‘èˆ‡è¥¿ç“œå¡ç´¯ç©æ—¥å¹£
                if(e.c === 'ç¾é‡‘' || e.c === 'è¥¿ç“œå¡') cashJpy += j;
            });

            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-5 rounded-2xl shadow-lg text-white mb-4">
                    <div class="flex justify-between items-start">
                        <div><h3 class="text-xs opacity-80 mb-1">ç¸½æ”¯å‡º (ç´„å°å¹£)</h3><div class="text-3xl font-bold">NT$ ${totalT.toLocaleString()}</div></div>
                        <div class="text-right"><h3 class="text-xs opacity-80 mb-1">ç¾é‡‘/è¥¿ç“œå¡</h3><div class="text-xl font-bold">Â¥ ${cashJpy.toLocaleString()}</div></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-4">
                    <h4 class="font-bold text-gray-700 mb-3 text-sm">æ–°å¢æ¶ˆè²»</h4>
                    <div class="space-y-3">
                        <input id="exp-name" placeholder="æ¶ˆè²»é …ç›® (å¦‚: æ™šé¤)" class="w-full border rounded-lg px-3 py-2.5 text-sm">
                        <div class="flex flex-col gap-2">
                             <input id="exp-j" type="number" placeholder="æ—¥å¹£ Â¥ (è‡ªå‹•æ›ç®—)" class="w-full border rounded-lg px-3 py-2.5 text-sm" oninput="calcTwd()">
                             <input id="exp-t" type="number" placeholder="å°å¹£ NT$" class="w-full border rounded-lg px-3 py-2.5 text-sm">
                        </div>
                        <div class="grid grid-cols-3 gap-2" id="pay-opts">
                             ${['Cube','å°æ–°','ä¸­ä¿¡','è¥¿ç“œå¡','ç¾é‡‘'].map(m => `<button onclick="setPay('${m}')" class="pay-btn text-xs py-2 rounded-lg bg-gray-50 flex-1">${m}</button>`).join('')}
                        </div>
                        <input type="hidden" id="exp-card">
                        <button onclick="addExp()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold shadow-md mt-2">åŠ å…¥è¨˜å¸³</button>
                    </div>
                </div>
                <div class="space-y-3 pb-20">
                    ${expenses.map((e, i) => `
                        <div class="bg-white p-3 rounded-xl border shadow-sm flex justify-between items-center">
                            <div><div class="font-bold text-gray-800">${e.n}</div><div class="text-xs text-gray-500">${e.c}</div></div>
                            <div class="text-right"><div class="font-bold">Â¥${e.j}</div><div class="text-xs text-gray-400">NT$${e.t}</div></div>
                            <button onclick="delExp(${i})" class="ml-2 text-gray-300"><i class="fas fa-trash"></i></button>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(wrapper);
            // Default select
            setPay('ç¾é‡‘');
        }
        window.calcTwd = () => { document.getElementById('exp-t').value = Math.round(document.getElementById('exp-j').value * 0.22); };
        window.setPay = (m) => {
            document.getElementById('exp-card').value = m;
            document.querySelectorAll('.pay-btn').forEach(b => {
                b.classList.remove('active', 'bg-green-600', 'text-white');
                b.classList.add('bg-gray-50', 'text-gray-500');
                if(b.innerText === m) {
                    b.classList.remove('bg-gray-50', 'text-gray-500');
                    b.classList.add('active', 'bg-green-600', 'text-white');
                }
            });
        };
        window.addExp = () => {
            const n = document.getElementById('exp-name').value;
            const j = document.getElementById('exp-j').value || 0;
            const t = document.getElementById('exp-t').value || 0;
            const c = document.getElementById('exp-card').value;
            if(!n) return;
            const exps = JSON.parse(localStorage.getItem('tokyoBudget')) || [];
            exps.push({n, j, t, c});
            localStorage.setItem('tokyoBudget', JSON.stringify(exps));
            switchDate('budget');
        };
        window.delExp = (i) => {
            const exps = JSON.parse(localStorage.getItem('tokyoBudget'));
            exps.splice(i, 1);
            localStorage.setItem('tokyoBudget', JSON.stringify(exps));
            switchDate('budget');
        };

        // Utils
        function copyCode(text) { navigator.clipboard.writeText(text).then(() => showToast(`å·²è¤‡è£½ï¼š${text}`)); }
        function showToast(msg) {
            const div = document.createElement('div');
            div.className = "toast-msg bg-black/80 text-white px-4 py-2 rounded-full fixed bottom-10 left-1/2 -translate-x-1/2 text-sm z-50";
            div.innerHTML = `<i class="fas fa-check mr-2"></i>${msg}`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2000);
        }

        // Init
        const btnContainer = document.getElementById('date-nav');
        const dayList = ['list', 'budget', 'day1', 'day2', 'day3', 'day4', 'day5'];
        
        dayList.forEach(id => {
            // HTML already has buttons
        });

        // Fetch Weather
        async function initWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.49&longitude=138.76&current=cloud_cover');
                const data = await res.json();
                const el = document.getElementById('fuji-status-badge');
                if(el) el.innerText = `${data.current.cloud_cover}% é›²é‡`;
            } catch(e){}
        }
        initWeather();
        
        switchDate('day1'); 

    </script>
</body>
</html>
